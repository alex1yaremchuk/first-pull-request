name: Test and Report 

on:
  push:
    branches:
      - main

# permissions:
#   issues: write

jobs:
  js-test-file-issue:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-versioin: '17'
    
    - name: Install dependencies
      run: | 
        cd javascript
        npm install

    - name: Install Zig using Snap
      run: |
        sudo snap install zig --classic --beta
      
    - name: Run tests JS
      id: run-tests-js
      run: |
        cd javascript
        npm test

    - name: Create Issue for JS Failure
      if: ${{ failure() && steps.run-test-js.outcome == 'failure' }}
      uses: ./.github/workflows/create-issue.yml
      with: 
        label: "javascript"
        lable_upper: "JAVASCRIPT"

    - name: Run tests Zig
      if: ${{ failure() || success() }}
      id: run-tests-zig
      run: |
        zig test zig/index.zig

    - name: Create Issue for Zig Failure
      if: ${{ failure() && steps.run-test-zig.outcome == 'failure' }}
      uses: ./.github/workflows/create-issue.yml
      with: 
        label: "zig"
        lable_upper: "ZIG"

  zig-build-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with: 
        fetch-depth: 0
        ref: refs/heads/main

    - name: Install Zig using Snap
      run: |
        sudo snap install zig --classic --beta

    - name: Config, Prepare branch
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout gh-pages || git checkout -b gh-pages
        git merge main --no-edit

    - name: Compile to WebAssembly
      run: |
        zig build

    - name: Commit built files to gh-pages
      run: |
        cp zig-out/bin/index.wasm .
        git add index.wasm
        git commit --allow-empty -m 'Update built index.wasm file'
        git push origin gh-pages
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


